image: docker:18.06.0

services:
- docker:18.06.0-dind

variables:
  GIT_SSL_NO_VERIFY: "true"
  ORTOLANG_DIFFUSION_IMAGE: $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$CI_COMMIT_REF_NAME

stages:
  - test
  - build

test:
  image: maven:3-jdk-8
  stage: test
  tags:
    - ortolang-docker-bind
  before_script:
    - curl -O "https://download.jboss.org/wildfly/11.0.0.Final/wildfly-11.0.0.Final.zip"
    - unzip wildfly-11.0.0.Final.zip
    - export JBOSS_HOME=$PWD/wildfly-11.0.0.Final
    - cp comp/src/test/resources/ortolang-users.properties wildfly-11.0.0.Final/standalone/configuration/
    - cp comp/src/test/resources/ortolang-roles.properties wildfly-11.0.0.Final/standalone/configuration/
    - cp comp/src/test/resources/ortolang-test-11.xml wildfly-11.0.0.Final/standalone/configuration/
  script: 
    - mvn clean test -DjbossHome=wildfly-11.0.0.Final -Djboss.home=wildfly-11.0.0.Final
  only:
    - master
    - branches
     
maven_docker_build:
  stage: build
  tags:
    - ortolang-docker-bind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $ORTOLANG_DIFFUSION_IMAGE --build-arg CUSTOM_UID=$OLREPO_UID --build-arg CUSTOM_GID=$OLREPO_GID --add-host=maven.ortolang.fr:192.168.37.63 .
    - docker push $ORTOLANG_DIFFUSION_IMAGE
  only:
    - master
    - tags
    - branches

