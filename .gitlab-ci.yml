image: docker:18.06.0

services:
- docker:18.06.0-dind

variables:
  GIT_SSL_NO_VERIFY: "true"
  ORTOLANG_DIFFUSION_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME

stages:
  - test
  - build
  - deploy

test:
  image: maven:3.6.1-jdk-8-alpine
  stage: test
  tags:
    - ortolang-docker-bind
  before_script:
    - export WILDFLY_VERSION=12.0.0.Final
    - curl -O "https://download.jboss.org/wildfly/${WILDFLY_VERSION}/wildfly-${WILDFLY_VERSION}.zip"
    - unzip wildfly-${WILDFLY_VERSION}.zip
    - export JBOSS_HOME=$PWD/wildfly-${WILDFLY_VERSION}
    - cp comp/src/test/resources/ortolang-users.properties wildfly-${WILDFLY_VERSION}/standalone/configuration/
    - cp comp/src/test/resources/ortolang-roles.properties wildfly-${WILDFLY_VERSION}/standalone/configuration/
    - cp comp/src/test/resources/ortolang-test-${WILDFLY_VERSION}.xml wildfly-${WILDFLY_VERSION}/standalone/configuration/standalone.xml
  script: 
    - mvn clean test -DjbossHome=$PWD/wildfly-${WILDFLY_VERSION} -Djboss.home=$PWD/wildfly-${WILDFLY_VERSION}
  only:
    refs:
      - master
      - branches
    changes:
      - Dockerfile
      - api/src/**/*
      - appli/src/**/*
      - comp/src/**/*
     
maven_docker_build:
  stage: build
  tags:
    - ortolang-docker-bind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $ORTOLANG_DIFFUSION_IMAGE --build-arg CUSTOM_UID=$OLREPO_UID --build-arg CUSTOM_GID=$OLREPO_GID --add-host=maven.ortolang.fr:192.168.37.63 .
    - docker push $ORTOLANG_DIFFUSION_IMAGE
  only:
    refs:
      - master
      - branches
    changes:
      - Dockerfile
      - api/src/**/*
      - appli/src/**/*
      - comp/src/**/*
      - src/main/docker/**/*

docker_tag_from_master:
  stage: build
  tags:
    - ortolang-docker-bind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker pull $CI_REGISTRY_IMAGE:master
    - docker tag $CI_REGISTRY_IMAGE:master $ORTOLANG_DIFFUSION_IMAGE
    - docker push $ORTOLANG_DIFFUSION_IMAGE
  only:
    - tags

deploy_on_dev:
  stage: deploy
  tags:
    - ortolang-docker-bind
  only:
    refs:
      - master
    changes:
      - Dockerfile
      - docker/*
      - api/src/**/*
      - appli/src/**/*
      - comp/src/**/*
      - src/main/docker/**/*
  environment:
    name: vdorto
    url: https://repo-dev.ortolang.fr/api/config/version
  image: registry2.atilf.fr/atilf/portainer-cli:1.6.0
  script:
    - portainer-cli -u $PORTAINER_USERNAME -p $PORTAINER_PASSWORD -b http://192.168.37.13:9000 deploy -e "Int√©gration-vdorto" -n ortolang-diffusion_vdorto -f docker/docker-stack.vdorto.yml
