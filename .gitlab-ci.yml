image: docker:18.06.0

services:
- docker:18.06.0-dind

variables:
  GIT_SSL_NO_VERIFY: "true"
  ORTOLANG_DIFFUSION_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME

stages:
  - test
  - build
  - deploy

test:
  image: maven:3-jdk-8
  stage: test
  tags:
    - ortolang-docker-bind
  before_script:
    - curl -O "https://download.jboss.org/wildfly/11.0.0.Final/wildfly-11.0.0.Final.zip"
    - unzip wildfly-11.0.0.Final.zip
    - export JBOSS_HOME=$PWD/wildfly-11.0.0.Final
    - cp comp/src/test/resources/ortolang-users.properties wildfly-11.0.0.Final/standalone/configuration/
    - cp comp/src/test/resources/ortolang-roles.properties wildfly-11.0.0.Final/standalone/configuration/
    - cp comp/src/test/resources/ortolang-test-11.xml wildfly-11.0.0.Final/standalone/configuration/
  script: 
    - mvn -q clean test -DjbossHome=$PWD/wildfly-11.0.0.Final -Djboss.home=$PWD/wildfly-11.0.0.Final
  only:
    refs:
      - master
      - branches
    changes:
      - Dockerfile
      - api/**/*
      - appli/**/*
      - comp/**/*
     
maven_docker_build:
  stage: build
  tags:
    - ortolang-docker-bind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $ORTOLANG_DIFFUSION_IMAGE --build-arg CUSTOM_UID=$OLREPO_UID --build-arg CUSTOM_GID=$OLREPO_GID --add-host=maven.ortolang.fr:192.168.37.63 .
    - docker push $ORTOLANG_DIFFUSION_IMAGE
  only:
    refs:
      - master
      - branches
    changes:
      - Dockerfile
      - api/**/*
      - appli/**/*
      - comp/**/*

docker_tag_from_master:
  stage: build
  tags:
    - ortolang-docker-bind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker pull $CI_REGISTRY_IMAGE:master
    - docker tag $CI_REGISTRY_IMAGE:master $ORTOLANG_DIFFUSION_IMAGE
    - docker push $ORTOLANG_DIFFUSION_IMAGE
  only:
    - tags

deploy_on_dev:
  stage: deploy
  tags:
    - ortolang-docker-bind
  only:
    refs:
      - master
    changes:
      - Dockerfile
      - docker/*
      - api/**/*
      - appli/**/*
      - comp/**/*
      - src/main/docker/**/*
  environment:
    name: vdorto
    url: https://repo-dev.ortolang.fr/api/config/version
  image: registry2.atilf.fr/atilf/portainer-cli:1.0.0
  script:
    - portainer-cli -u $PORTAINER_USERNAME -p $PORTAINER_PASSWORD -b http://192.168.37.13:9000 deploy -e "Int√©gration-vdorto" -n ortolang-diffusion_vdorto -f docker/docker-stack.vdorto.yml
